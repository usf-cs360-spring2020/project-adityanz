<!DOCTYPE html>
<html lang="en">

<style type="text/css">
svg#vis {
  background-color: lightblue;
  text-align: center;
  font-family: sans-serif;
  font-size: 9pt;
  fill: black;
}

#tooltip {
  font-weight: 600;
  text-shadow: 0px 0px 2px white;

  fill: black;
  stroke: black;
}

#dropdown {
    margin-bottom: 20px;
    margin-right: 35px;
}

path.land {
  fill: #dddddd;
  stroke: none;
}

path.neighborhood {
  fill: none;
  stroke: white;
  stroke-width: 3.5px;
  pointer-events: none;
}

path.street {
  fill: none;
  stroke: white;
  stroke-width: 1px;
  pointer-events: none;
}

.active {
  stroke: red !important;
  stroke-width: 1.5px !important;
}

path.muni {
  fill: none;
  stroke: white;
  stroke-width: 1px;
  pointer-events: none;
}

circle.symbol {
  fill-opacity: 0.6;

  stroke: white;
  stroke-width: 1px;
}

a:link, a:visited {
  color: #444444;
}

a:hover, a:active {
  color: red;
}

th {
  text-align: right;
}


.axis line {
  fill: none;
  stroke: #000000;
}

div.tooltip-donut {
    position: absolute;
    text-align: center;
    padding: .1rem;
    background: #FFFFFF;
    color: #313639;
    border: 1px solid #313639;
    border-radius: 8px;
    pointer-events: none;
    font-size: 0.6rem;
}

.aditya {
  background-color: white;
  border: 1px solid white;
}

.icon:before {
    font-family: "Font Awesome 5 Free";
}

</style>


<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Final Prototype</title>

    <!-- Load Bulma from CDN (consider saving it to repository instead) -->
    <!-- https://bulma.io/ -->
    <link rel="stylesheet" href="https://jenil.github.io/bulmaswatch/darkly/bulmaswatch.min.css">

    <!-- Load Font Awesome 5 (free) icons -->

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

</head>

  <body>

  <div id="navigation">
  </div>
  <script>
  $(function(){
    $("#navigation").load("navbar.html");
  });
  </script>


      <section class="section is-centered">
        <select id="dropdown"></select>
          <div>

            <svg width="960" height="600" id="vis">
            <g id="basemap"></g>

            <!-- turn off pointer events for certain groups -->
            <g id="streets" pointer-events="none"></g>
            <g id="outline" pointer-events="none"></g>

            <g id="arrests"></g>
            <g id="tooltip" pointer-events="none"></g>
            <g id="details" pointer-events="none"></g>
          </svg>

          <svg class="aditya" id="bar"></svg>

          </div>
            </section>

            <script>

            // location of data files
            let bar = 'stackedbardata.csv';


            let config = {
              'svg': {},
              'margin': {},
              'plot': {}
            };

            config.svg.height = 450;
            config.svg.width = config.svg.height * 1.618; // golden ratio

            config.margin.top = 10;
            config.margin.right = 10;
            config.margin.bottom = 20;
            config.margin.left = 80;

            config.plot.x = config.margin.left;
            config.plot.y = config.margin.top;
            config.plot.width = config.svg.width - config.margin.left - config.margin.right;
            config.plot.height = config.svg.height - config.margin.top - config.margin.bottom;

            let margin = {top: 10, right: 10, bottom: 10, left: 10}
              , width =960
              , height = 450

              var yScale = d3.scaleBand()
              .range([margin.top, height - margin.bottom])
              .padding(0.1)
            .paddingOuter(0.2)
                  .rangeRound([0, height])
                  .align(0.1);

            var xScale = d3.scaleLinear()
                  .rangeRound([0, width-200]);

            var zScale = d3.scaleOrdinal()
                      .range(["#D73F47", "#ABA09C", "#ED7A22", "#65A9A3"]);



            let svg;

            // load data
            // d3.csv(bar, convertRow).then(drawMain);

            let parseColumnName = d3.timeParse('%Y');



            const urls = {
  basemap: "https://data.sfgov.org/resource/xfcw-9evu.geojson",
  zip: "https://data.sfgov.org/resource/f9wk-m4qb.geojson",
  streets: "https://data.sfgov.org/resource/hn5x-7sr8.geojson?$limit=8000",
  muni: "https://data.sfgov.org/resource/9exe-acju.geojson"
  // arrests: "https://data.sfgov.org/resource/nwbb-fxkq.json"
};

// calculate date range
const end = d3.timeDay.floor(d3.timeDay.offset(new Date(), -1));
const start = d3.timeDay.floor(d3.timeDay.offset(end, -7));
const format = d3.timeFormat("%Y-%m-%dT%H:%M:%S");
console.log(format(start), format(end));

svg = d3.select("body").select("svg#vis");

const g = {
  basemap: svg.select("g#basemap"),
  streets: svg.select("g#streets"),
  outline: svg.select("g#outline"),
  muni: svg.select("g#muni"),
  arrests: svg.select("g#arrests"),
  tooltip: svg.select("g#tooltip"),
  details: svg.select("g#details")
};

// setup tooltip (shows neighborhood name)
const tip = g.tooltip.append("text").attr("id", "tooltip");
tip.attr("text-anchor", "end");
tip.attr("dx", -5);
tip.attr("dy", -5);
tip.style("visibility", "hidden");

// add details widget
// https://bl.ocks.org/mbostock/1424037
const details = g.details.append("foreignObject")
  .attr("id", "details")
  .attr("width", 960)
  .attr("height", 600)
  .attr("x", 0)
  .attr("y", 0);

const body = details.append("xhtml:body")
  .style("text-align", "left")
  .style("background", "none")
  .html("<p>N/A</p>");

details.style("visibility", "hidden");

// setup projection
// https://github.com/d3/d3-geo#geoConicEqualArea
const projection = d3.geoConicEqualArea();
projection.parallels([37.692514, 37.840699]);
projection.rotate([122, 0]);

// setup path generator (note it is a GEO path, not a normal path)
const path = d3.geoPath().projection(projection);

d3.json(urls.basemap).then(function(json) {
  // makes sure to adjust projection to fit all of our regions
  projection.fitSize([960, 600], json);

  // draw the land and neighborhood outlines
  drawBasemap(json);

  // now that projection has been set trigger loading the other files
  // note that the actual order these files are loaded may differ

  d3.json(urls.streets).then(drawStreets)
  // d3.json(urls.muni).then(drawMuni)
  d3.csv("small.csv").then(drawArrests);
});
            function convertRow(row, index) {
              let out = {};
              var i =0;

              for (i =0; i< row.length; i++)
              {
              console.log(row[i]["Price"]);
              // this will be our converted output row
              //out.values = [];
              out.total;
              // this will be the values from each yyyy-mm column
              for (let col in row) {
                switch (col) {      // these are the text columns that do not need conversion
                  // these are the columns that need to be converted to integers
                  default:
                  var type = row[col];
                  console.log("IND")
                  var value = parseInt(row['Inspection Score'])
                  // var type = value;
                  out[type] = value;
                  out.total = value;
                  // var value = parseInt(row["Avg. Inspection Score"])
                  // var time  = parseFloat(row["Price"]).toFixed(2);
                  //  out[type] = value;
                  //  // out[type+" zip code"] = zip code;
                  //  out.total = value;
                   break;
                }
              }
            }
              console.log(out);
              return out;
            }

            function drawMain(data) {
              // console.log("data")
              // console.log(data)
              var newdata = []
              var output = []


              var keys = ['$','$$','$$$','$$$$','total', 'Zip Code']
              var i;
              var j;
              // console.log(data)


            // console.log(data['$']);



              data.forEach(function(item){
              var exist = output.filter(function(v,i){
              return v["Zip Code"] == item["Zip Code"];
            });
            if(exist.length){
              var index = output.indexOf(exist[0]);
              // console.log(index);
              var total = output[index].total + item.total;
              Object.assign(output[index], item);
              // console.log(total);
              output[index].total = total;
            } else{
              if(typeof item.value == 'string'){
                item.value = [item.value];
              }
              output.push(item);
            }
            });
              output.sort(function(a, b) { return b.total - a.total; });

              for (j = 0; j< output.length; j++){

                console.log("og item")
                console.log(output[j])
                const temp = new Object();
                  for (i=0; i<keys.length; i++)
                  {
                    // console.log(item["$$$"])
                    // console.log(item[keys[i]])
                    if (output[j].hasOwnProperty(keys[i]) === false)
                    {
                      // console.log(keys[i])
                      // console.log(data[j][keys[i]])
                      output[j][keys[i]] = 0;
                      temp[keys[i]] = output[j][keys[i]]
                      // temp[j] = {};
                      // temp[j][keys[i] = data[j][keys[i]];
                    }
                    else{
                      // console.log(keys[i])
                      // console.log(data[j][keys[i]])
                      temp[keys[i]] = output[j][keys[i]]
                    }
                    // console.log(temp);
                  }
                  newdata[j] = temp;
                  console.log("new item")
                  console.log(newdata[j])
            };

              console.log("keys")
              console.log(keys)


              console.log("output")
              console.log(output)

              console.log("newdata")
              console.log(newdata)

              console.log("d3")
              console.log(d3.stack().keys(keys)(newdata))
              // console.log(data)
              // console.log(output)

              var keys_color = ['$','$$','$$$','$$$$']

              xScale.domain([0,350])


              yScale.domain(output.map(function(d) {  return d["Zip Code"]; }));

              zScale.domain(keys_color)
              // console.log(output);

              var div = d3.select("body").append("div")
               .attr("class", "tooltip-donut")
               .style("opacity", 0);

              svg = d3.select("svg#bar")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                svg.append("g")
                 .attr("class", "axis")
                 .attr("transform", "translate(80,0)")
                 .style("stroke","lightslategray")
                 .call(d3.axisLeft(yScale));
            svg.append("g")
              .attr("class", "axis")
              .attr("transform", "translate(80,440)")
              .style("stroke","lightslategray")
              .call(d3.axisBottom(xScale));

            svg.selectAll(".bar")
            .data(d3.stack().keys(keys_color)(newdata))
            .enter().append("g")
              .attr("fill", function(d) {return zScale(d.key) })
            .selectAll("rect").data(function (d){ return d; })
            .enter().append("rect")
            .attr("transform", "translate(80,0)")
            .attr("y", function(d) { return yScale(d.data["Zip Code"]) })
            .attr("x", function(d) { return xScale(d[0]) })
            .attr("width", function(d) {
              return xScale(d[1]) - xScale(d[0]); })

            .on("mouseover", function(d) {
                    d3.select(this).transition()
                           .duration('50')
                           .attr('opacity', .50);

                    div.transition()
                           .duration(50)
                           .style("opacity", 1)

                  let format = d3.format(",")
                  // let key = Object.keys(d.data).find(key => d.data[key]);
                  // let alarmcount = d[1]-d[0];
                  // let time = 0;
                  // for (var i = 0; i< data.length;i++)
                  // {
                  //   if (data[i][key] == alarmcount)
                  //   {
                  //     time = data[i][key+" time"];
                  //   }
                  // }

                  // console.log(key)
                  // console.log(d[1]-d[0])
                  // console.log(Object.values(data))
                  div.html(" Price Category: " + d.data["Price"] + "<br>" + "Zip Code: "+d.data["Zip Code"] + "<br>" +"Total Avg. Inspection Score: "+ format(d[1]-d[0])  + "<br>")
                      .style("left", (d3.event.pageX - 30) + "px")
                      .style("top", (d3.event.pageY - 15) + "px")

            		})
              .on("mouseout", function(d) {d3.select(this).transition()
                           .duration('50')
                           .attr('opacity', 1)
                    div.transition()
                           .duration('50')
                           .style("opacity", 0)
                }) 
            .transition()
            .duration(2000)//time in ms
            .attr("height", function(d){
                return yScale.bandwidth()
            })

            // svg.select("#legend")
            // svg.append("circle").attr("cx",870).attr("cy",30).attr("r", 6).style("fill", "#65A9A3")
            // svg.append("circle").attr("cx",870).attr("cy",50).attr("r", 6).style("fill", "#ED7A22")
            // svg.append("circle").attr("cx",870).attr("cy",70).attr("r", 6).style("fill", "#ABA09C")
            // svg.append("circle").attr("cx",870).attr("cy",100).attr("r", 6).style("fill", "#D73F47")
            // svg.append("text").attr("x", 863).attr("y", 10).text("Call Type Group").style("font-size", "12px").attr("alignment-baseline","middle")
            // svg.append("text").attr("x", 880).attr("y", 30).text("Alarm").style("font-size", "10px").attr("alignment-baseline","middle")
            // svg.append("text").attr("x", 880).attr("y", 50).text("Fire").style("font-size", "10px").attr("alignment-baseline","middle")
            // svg.append("text").attr("x", 880).attr("y", 70).text("Non").style("font-size", "10px").attr("alignment-baseline","middle")
            // svg.append("text").attr("x", 880).attr("y", 80).text("Life Threatening").style("font-size", "10px").attr("alignment-baseline","middle")
            // svg.append("text").attr("x", 880).attr("y", 100).text("Potentially").style("font-size", "10px").attr("alignment-baseline","middle");
            // svg.append("text").attr("x", 880).attr("y", 110).text("Life Threatening").style("font-size", "10px").attr("alignment-baseline","middle")
            //
            // svg.append('text')
            //     .attr('class', 'axis-title')
            //     .attr('x', 37)
            //     .attr('y',-5)
            //     .attr('text-anchor', 'middle')
            //     .style("font-size", "10px")
            //     .text('Zip Code');
            //
            // svg.append('text')
            //   .attr('class', 'axis-title')
            //   .attr('x', 470)
            //   .attr('y', 442)
            //   .attr('dy', '1.75ex')
            //   .attr('text-anchor', 'middle')
            //   .style("font-size", "12px")
            //   .text('Avg. Inspection Score');
            //
            //   svg.append('text')
            //     .attr('class', 'title')
            //     .attr('x', 442)
            //     .attr('y',-25)
            //     .attr('dy', '1.75ex')
            //     .attr('text-anchor', 'middle')
            //     .attr("font-weight", 600)
            //     .style("font-size", "16")
            //     .text('Bar Graph of the Avg. Inspection Score based on the areas in the last 10 years');

            }




function drawBasemap(json) {
  console.log("basemap", json);

  const basemap = g.basemap.selectAll("path.land")
    .data(json.features)
    .enter()
    .append("path")
    .attr("d", path)
    .attr("class", "land");

  const outline = g.outline.selectAll("path.neighborhood")
      .data(json.features)
      .enter()
      .append("path")
      .attr("d", path)
      .attr("class", "neighborhood")
      .each(function(d) {
        // save selection in data for interactivity
        // saves search time finding the right outline later
        d.properties.outline = this;
      });

  // add highlight
  basemap.on("mouseover.highlight", function(d) {
    d3.select(d.properties.outline).raise();
    d3.select(d.properties.outline).classed("active", true);
  })
  .on("mouseout.highlight", function(d) {
    d3.select(d.properties.outline).classed("active", false);
  });

  // add tooltip
  basemap.on("mouseover.tooltip", function(d) {
    tip.text(d.properties.nhood);
    tip.style("visibility", "visible");
  })
  .on("mousemove.tooltip", function(d) {
    const coords = d3.mouse(g.basemap.node());
    tip.attr("x", coords[0]);
    tip.attr("y", coords[1]);
  })
  .on("mouseout.tooltip", function(d) {
    tip.style("visibility", "hidden");
  });
}

function drawStreets(json) {
  console.log("streets", json);

  const streets = json.features.filter(function(d) {
    return d;
  });


  console.log("removed", json.features.length - streets.length, "inactive streets");

  g.streets.selectAll("path.street")
    .data(streets)
    .enter()
    .append("path")
    .attr("d", path)
    .attr("class", "street");
}

let remover = '0';
function drawArrests(json) {
  console.log("arrests", json);

  // loop through and add projected (x, y) coordinates
  // (just makes our d3 code a bit more simple later)
  json.forEach(function(d) {
    const latitude = parseFloat(d.Latitude);
    const longitude = parseFloat(d.Longitude);
    const pixels = projection([longitude, latitude]);

    d.x = pixels[0];
    d.y = pixels[1];
  });
  console.log("og");

  //


      var dropdown_options = [
        { value: "0",
          text: "All" },
      { value: "Low Risk",
        text: "Low Risk" },
        { value: "Moderate Risk",
        text: "Medium Risk" },
          { value: "High Risk",
          text: "High Risk" },
            { value: "No Risk",
            text: "No Risk" }]
            //   { value: "5",
            //   text: "Health Score: 78-74" },
            //     { value: "6",
            //     text: "Health Score: 74 or lower" },
            //       { value: "7"}]
        d3.select("#dropdown")
          .selectAll("option")
          .data(dropdown_options)
          .enter()
          .append("option")
          .attr("value", function(option) { return option.value; })
          .text(function(option) { return option.text; });

    var dropDown = d3.select("#dropdown");
    dropDown.on("change", function() {
        // newly selected dataset includes downtown
        d3.select("#downtown")
          .property("checked", true);

        checked = true;

        selected_dataset = d3.event.target.value;
        remover = selected_dataset.toString();
        console.log(selected_dataset)
        console.log("in add")
          symbols.remove()
          drawArrests(json)
          symbols.filter(d=> d["Risk Category Improved"])
          console.log(remover)
          symbols.filter(d => d["Risk Category Improved"] != remover).remove();
          console.log("in remove")
    });


    var symbols = g.arrests.selectAll("circle")
        .data(json)
        .enter()
        .append("circle")
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .attr("r", 5)
        .attr("class", "symbol")
        .style("fill","000000")
      // symbols.filter(d => d['Risk Category Improved'] !== selected_dataset)

          symbols.filter(d => d['Rating'] === 1).style("fill","FF0000")
          symbols.filter(d => d['Rating'] === 2).style("fill","0000ff")
          symbols.filter(d => d['Rating'] === 3).style("fill","FF7F00");
          symbols.filter(d => d['Rating'] === 4).style("fill","6a0dad");
          console.log(remover)
          if (remover != '0')
          {
            console.log(remover)
            symbols.filter(d => d["Risk Category Improved"] != remover).remove();
          }




    symbols.on("mouseover", function(d) {
      d3.select(this).raise();
      d3.select(this).classed("active", true);


        symbols.on("mouseout", function(d) {
          d3.select(this).classed("active", false);
          details.style("visibility", "hidden");
        });


    // use template literal for the detail table
    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals
    const html = `
      <table border="0" cellspacing="0" cellpadding="2">
      <tbody>
        <tr>
          <th>Name:</th>
          <td>${d['Name']}</td>
        </tr>
        <tr>
          <th>Address:</th>
          <td>${d['Address']}</td>
        </tr>
        <tr>
          <th>Recent Health Inspection Score:</th>
          <td>${d['Inspection Score']}</td>
        </tr>
        <tr>
          <th>Risk Category:</th>
          <td>${d['Risk Category Improved']}</td>
        </tr>
        <tr>
          <th>Yelp Rating:</th>
          <td>${d['Rating']}</td>
        </tr>
      </tbody>
      </table>
    `;

    body.html(html);
    details.style("visibility", "visible");
  });

  var zoom = d3.zoom()
  .scaleExtent([1, 8])
        .on('zoom', function() {
            svg.selectAll('path')
             .attr('transform', d3.event.transform)
            svg.select("g#arrests").selectAll("circle")
            // console.log("this ffer",d3.event.transform)
            .attr('transform', d3.event.transform)
            .attr("r", 3/d3.event.transform.k);
  });



  // svg.select("#legend")
  // svg.append("circle").attr("cx",870).attr("cy",30).attr("r", 6).style("fill", "#000000")
  // svg.append("circle").attr("cx",870).attr("cy",50).attr("r", 6).style("fill", "#FF0000")
  // svg.append("circle").attr("cx",870).attr("cy",70).attr("r", 6).style("fill", "#0000ff")
  // svg.append("circle").attr("cx",870).attr("cy",90).attr("r", 6).style("fill", "#FF7F00")
  // svg.append("circle").attr("cx",870).attr("cy",110).attr("r", 6).style("fill", "#6a0dad")
  // svg.append("text").attr("x", 800).attr("y", 10).text("Type of Complaint").style("font-size", "12px").attr("alignment-baseline","middle")
  // svg.append("text").attr("x", 880).attr("y", 30).text("Other").style("font-size", "10px").attr("alignment-baseline","middle")
  // svg.append("text").attr("x", 880).attr("y", 50).text("Pass").style("font-size", "10px").attr("alignment-baseline","middle")
  // svg.append("text").attr("x", 880).attr("y", 70).text("Delay").style("font-size", "10px").attr("alignment-baseline","middle")
  // svg.append("text").attr("x", 880).attr("y", 90).text("Discourtesy").style("font-size", "10px").attr("alignment-baseline","middle")
  // svg.append("text").attr("x", 880).attr("y", 110).text("NextMuni").style("font-size", "10px").attr("alignment-baseline","middle")
  //

  svg.append('text')
  .attr('class', 'title')
  .attr('x', 500)
  .attr('y',0)
  .attr('dy', '1.75ex')
  .attr('text-anchor', 'middle')
  .attr("font-weight", 600)
  .style("font-size", "16")
  // .text('MUNI 311 Calls for Feburary 2020 in SF');

  svg.call(zoom);

  var filteredData = json.filter(function(d)
  {
        if (d["Risk Category Improved"] == remover)
        {
          return d["Risk Category Improved"];
        }
        else if (remover == 0) {
          return d["Risk Category Improved"];
        }

    });

    console.log(filteredData);

var bar_data = filteredData.map(function(d) {
  return {
            'Price': d["Price1"],
            'Zip Code': d["Zip Code"],
            'Inspection Score': d["Inspection Score"]
          }
});

// d3.csv(bar_data, convertRow).then(drawMain);

convertRow(bar_data);

        console.log(bar_data);

            function translate(x, y) {
              return 'translate(' + x + ',' + y + ')';
            }

            function midpoint(range) {
                return range[0] + (range[1] - range[0]) / 2.0;
              }

}
            </script>


  <div id="footer">
  </div>
  <script>
  $(function(){
    $("#footer").load("footer.html");
  });
  </script>

  </body>

</html>
